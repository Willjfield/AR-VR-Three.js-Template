<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <title>mask_template</title>
  <link rel="stylesheet" type="text/css" href="css/style.css">

</head>
<body>
<script type="text/javascript" src="js/three.min.js"></script>
<script src="js/StereoEffect.js"></script>
<script type="text/javascript" src="js/Detector.js"></script>
<script type="text/javascript" src="js/CanvasRenderer.js"></script>
<script type="text/javascript" src="js/Projector.js"></script>
<script type="text/javascript" src="js/stats.min.js"></script>

<div id="render-canvas" style="border:none">

  <!-- cam -->
  <p id="errorMessage" style="display:none"></p>
  <video id="video" autoplay loop width="480" height="320" style="display:none"></video>
  <canvas id="videoImage" width="480" height="320" style="display:none"></canvas>
  <canvas id="imageCanvas" width="100" height="100" style="display:none">
  </div>

  <script type="text/javascript">
  var video = document.getElementById('video');
  var videoImage = document.getElementById('videoImage');
  var videoTexture;
  var scene, camera, renderer, stats;
  var videoImageContext;
  var videoWidth = 480, videoHeight = 320;
  var container;
  var movieMaterial, movieGeometry, movieScreen;
  var imageInfo, data;
  var videoImageContext = videoImage.getContext('2d');
  var audio = document.getElementById ('audio');
  var vo = document.getElementById ('vo');
  var voEnded = false;
  var theDate;

  var imageCanvas = document.getElementById ('imageCanvas');
  var imageCanvasContext = imageCanvas.getContext ('2d');

  var drawY = 3;

  var isFullscreen = false;

  // ref: https://github.com/samdutton/simpl/blob/master/getusermedia/sources/js/main.js
  var audioSource = null, videoSource = null, camUserID = null, camEnvironmentID = null;
  var mediaConstraints = {};

  var x=0;
  var y=0;
  var z=0;
  var alpha=0;
  var beta=0;
  var gamma=0;

  var hasPlayed = false;
  var cube;

  window.addEventListener('click', fullscreen, true);
  window.addEventListener('devicemotion', ondevicemotion, false);
  window.addEventListener('deviceorientation', onOrientationChange, false);

  function gotSources(sourceInfos) {
    for (var i = 0; i !== sourceInfos.length; ++i) {
      var sourceInfo = sourceInfos[i];
      if (sourceInfo.kind === 'video') {
        if (sourceInfo.facing === 'user') camUserID = sourceInfo.id;
        else if (sourceInfo.facing === 'environment') {
          camEnvironmentID = sourceInfo.id;
          mediaConstraints = {
            video: {
              mandatory: {
                maxWidth: 480,
                maxHeight: 320,
                minWidth: 480,
                minHeight: 320
              },
              optional: [{sourceId: camEnvironmentID}]
            }
          };
          navigator.getUserMedia(mediaConstraints, successCallback, errorCallback);
        }
        else {
          camEnvironmentID = sourceInfo.id;
          mediaConstraints = {
            video: {
              mandatory: {
                maxWidth: 480,
                maxHeight: 320,
                minWidth: 480,
                minHeight: 320
              },
              optional: [{sourceId: camEnvironmentID}]
            }
          };
          navigator.getUserMedia(mediaConstraints, successCallback, errorCallback);
        }
      }
    }
  }

  // for selecting back camera of phone
  if (typeof MediaStreamTrack.getSources === 'undefined'){
    alert('This browser does not support MediaStreamTrack.\n\nTry Chrome Canary.');
  } else {
    MediaStreamTrack.getSources(gotSources);
  }
  navigator.getUserMedia = navigator.getUserMedia ||
  navigator.webkitGetUserMedia || navigator.mozGetUserMedia;



  function successCallback(stream) {
    video.src = window.URL.createObjectURL(stream);
    video.play();

    init ();
  }


  function errorCallback(error){
    var msg = 'No camera available.';
    if (error.code == 1)
    {   msg = 'User denied access to use camera.';   }
    document.getElementById('errorMessage').textContent = msg;
    console.log('navigator.getUserMedia error: ', error);
  }

  function init () {

    container = document.getElementById('render-canvas');

    renderer = new THREE.WebGLRenderer({
      antialias: true,
      alpha: true
    });
    renderer.setClearColor(0x000000);
    renderer.autoClear = false;
    container.appendChild(renderer.domElement);

    effect = new THREE.StereoEffect( renderer );
    effect.separation = 0.2;
    effect.targetDistance = 50;
    effect.setSize( window.innerWidth, window.innerHeight );

    scene = new THREE.Scene();

    // texture for 3d - screen
    videoTexture = new THREE.Texture( videoImage);
    videoTexture.minFilter = THREE.LinearFilter;
    videoTexture.magFilter = THREE.LinearFilter;
    videoTexture.format = THREE.RGBFormat;
    videoTexture.generateMipmaps = false;

    videoTexture.wrapS = videoTexture.wrapT = THREE.ClampToEdgeWrapping;
    videoTexture.needsUpdate = true;

    movieMaterial = new THREE.MeshBasicMaterial( { map: videoTexture, overdraw: true, side:THREE.DoubleSide } );
    // the geometry on which the movie will be displayed;
    //      movie image will be scaled to fit these dimensions.
    movieGeometry = new THREE.PlaneBufferGeometry( 110, 100, 4, 4 );
    movieScreen = new THREE.Mesh( movieGeometry, movieMaterial );

    camera = new THREE.PerspectiveCamera(27, window.innerWidth / window.innerHeight, 1, 10000 );
    camera.position.set(0,0,200);

    scene = new THREE.Scene();
    scene.add(camera);
    camera.add(movieScreen);
    movieScreen.position.set(0,0,-400);
    movieScreen.scale.set(2,2,2);

    var geometry = new THREE.BoxGeometry( 10, 10, 10 );
    var material = new THREE.MeshLambertMaterial( {color: 0x88ff00} );
    cube = new THREE.Mesh( geometry, material );

    scene.add( cube );
    cube.position.set(0,0,-100);
    var light = new THREE.PointLight( 0xffffff );
    light.position.set( 0, 10, 200 );
    scene.add( light );

    animate ();
  }

  function animate() {
    camera.rotation.set(-gamma* (Math.PI/180),beta* (Math.PI/180),0);
    requestAnimationFrame( animate );
    cube.rotateX(.01);
    cube.rotateY(.01);
    cube.rotateZ(.01);
    update();
    render();
  }

  function update() {
    // WEB_CAM
    if(video.readyState === video.HAVE_ENOUGH_DATA){
      videoImageContext.drawImage(video, 0,0);

      // update texture for 3D
      if(videoTexture){
        videoTexture.flipY = true;
        videoTexture.needsUpdate = true;
      }
    }

    //get Date
    var tempDate = new Date();
    theDate = tempDate.toUTCString();
  }

  function render() {
    effect.render( scene, camera );
  }

  function fullscreen() {
    isFullscreen = true;

    if (container.requestFullscreen) {
      container.requestFullscreen();
    } else if (container.msRequestFullscreen) {
      container.msRequestFullscreen();
    } else if (container.mozRequestFullScreen) {
      container.mozRequestFullScreen();
    } else if (container.webkitRequestFullscreen) {
      container.webkitRequestFullscreen();
    }
  }

  function ondevicemotion(e) {
      var tempX = e.acceleration.x;
      var tempY = e.acceleration.y;
      var tempZ = e.acceleration.z;
  };

  function onOrientationChange(e) {
    if(window.orientation<=0){
      alpha=-e.alpha;
      beta=-e.beta;
      gamma=-e.gamma;
    }else{
      alpha=e.alpha;
      beta=e.beta;
      gamma=e.gamma;
    }
  };
  </script>

</body>
</html>
